<%-include('../layouts/adminHeader')%>
    <%-include('../layouts/adminSidebar')%>

        <div class="pc-container" style="background-color: rgb(234, 230, 230);">
            <div class="pcoded-content">
                <div class="page-header">
                    <div class="page-block">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="page-header-title">
                                    <h5 class="m-b-10">Offer</h5>
                                </div>
                                <ul class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                    <li class="breadcrumb-item">offers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container" style="display: flex; justify-content: right; margin-top:45px;">
                    <a href="#" class="btn btn-dark" data-toggle="modal" data-target="#offerModal">Add New Offer+</a>
                </div>
                <div class="modal fade" id="offerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">New Offer</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <!-- Your form or content for the new offer goes here -->
                                <form>
                                    <div class="form-group">
                                        <label for="product-name">Product Name</label>
                                        <select class="form-control" id="product-name">
                                          <option value="" disabled selected>Select Product</option>
                                          <% products.forEach(product=>{%>
                                          <option id="product-name" value="<%= product._id %>"><%= product.name %></option>
                                          <%}) %>
                                        </select>
                                      </div>
                                    <div class="form-group">
                                        <label for="offer-amount">Offer Amount</label>
                                        <input type="number" class="form-control" id="offer-amount"
                                            placeholder="Enter Offer Amount">
                                    </div>
                                    <div class="form-group">
                                        <label for="offer-Expiry-Date">Offer Expiry Date</label>
                                        <input type="date" class="form-control" id="offer-Expiry-Date"
                                            placeholder="Enter Expiry Date"></input>
                                    </div>
                                    <!-- Add more form fields as needed -->
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="button" onclick="offeradding()" class="btn btn-primary">Save Offer</button>
                                </div>    
                            </form>
                        
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Offers</h4>
                                <div class="table-responsive">
                                    <table id="zero_config" class="table table-striped table-bordered no-wrap">
                                        <% if(offer&&offer.length>0) { %>
                                        <thead>
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Offer</th>
                                                <th scope="col">Start Date</th>
                                                <th scope="col">Expiry Date</th>
                                                <th scope="col">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% offer.forEach((item,index)=>{%>
                                            <tr>
                                                <td>
                                                    <%= index+1 %>
                                                </td>
                                                <td>
                                                    <%= item.productId.name %>
                                                </td>
                                                <td>
                                                    <%= item.discount %>%
                                                </td>
                                                <td>
                                                    <%= new Date(item.startDate).toLocaleString('en-IN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})  %>
                                                </td>
                                                <td>
                                                    <%= new Date(item.expiryDate).toLocaleString('en-IN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})  %>
                                                </td>
                                                <td>
                                                    <% if(item.is_active === false) { %>
                                                        <button type="button" class="btn btn-success" onclick="changeOfferStatus('<%= item._id %>')">List</button>
                                                    <% } else { %>
                                                        <button type="button" class="btn btn-dark" onclick="changeOfferStatus('<%= item._id %>')">Unlist</button>
                                                    <% } %>
                                                </td>
                                            </tr>
                                            <%}) %>
                                        </tbody>
                                            <% } else { %>
                                            <tr>
                                                <td colspan="5">offer not available</td>
                                            </tr>
                                            <% } %>
                                        
                                    </table> 
                                        
                                </div>
                            </div>
                        </div>
                    </div>
                </div>        

                        <script>
                            function offeradding(){
                                let productId=$("#product-name").val()
                                let offerAmount=$('#offer-amount').val()
                                let expDate=$('#offer-Expiry-Date').val()

                                fetch('/admin/addOffer',{
                                    method:'post',
                                    headers:{
                                        'Content-Type':'application/json'
                                    },
                                    body:JSON.stringify({
                                        productId,
                                        offerAmount,
                                        expDate
                                    })
                                }).then(response=>response.json())
                                .then(data=>{
                                    if(data.success){
                                        Swal.fire(
                                            'success',
                                            'offer amount successfuly added',
                                            'success'
                                        ).then(()=>{
                                            window.location.reload()
                                        })
                                    }
                                })
                            }
                        </script>
                        <script>
                            function changeOfferStatus(offerId){
                                Swal.fire({
                                    title:'are you sure',
                                    icon:'question',
                                    showCancelButton:true,
                                    confirmButtonColor:'#3085d6',
                                    cancelButtonColor:'#d33',
                                    confirmButtonText:`Yes`,
                                }).then(result=>{
                                    if(result.isConfirmed){
                                        fetch('/admin/changeStatus',{
                                            method:'post',
                                            headers:{
                                                'Content-Type':'application/json'
                                            },
                                            body:JSON.stringify({
                                                offerId
                                            })
                                        })
                                        .then(response => response.json())
                                        .then(data=>{
                                            if(data.success){
                                                window.location.reload()
                                            }
                                        })
                                    }
                                })
                            }
                        </script>

                        <%-include('../layouts/adminFooter')%>