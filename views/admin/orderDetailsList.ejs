<%- include('../layouts/adminHeader') %>
<%- include('../layouts/adminSidebar') %>

<style>
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; 
    }

    table {
        width: 100%; 
        border-collapse: collapse; 
    }

    td, th {
        padding: 8px;
        text-align: left; 
    }

    img {
        max-width: 100%;
        height: auto; 
    }

    @media (max-width: 767px) {
        table, thead, tbody, th, td, tr {
            display: block; 
        }

        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        tr {
            margin: 0 0 1rem 0; 
        }

        td {
            border: none;
            border-bottom: 1px solid #eee;
            position: relative;
            padding-left: 50%; 
        }

        td:before {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            content: attr(data-label);
            font-weight: bold;
        }
    }
</style>

<div class="pc-container" style="background-color: rgb(234, 230, 230);">
    <div class="pcoded-content">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header text-center">Order Details</div>
                    <div class="card-body">
                        <% if (orders && orders.length > 0) { %>
                            <% orders.forEach(order => { %>
                                <% if (order.addressDetails) { %>
                                    <p>Name: <%= order.addressDetails.name %></p>
                                    <p>Pincode: <%= order.addressDetails.pincode %></p>
                                    <p>State: <%= order.addressDetails.state %></p>
                                    <p>District: <%= order.addressDetails.dist %></p>
                                    <p>City: <%= order.addressDetails.city %></p>
                                    <p>House No: <%= order.addressDetails.houseNo %></p>
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <p>No orders found.</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Order Info</div>
                    <div class="card-body">
                        <% if (orders && orders.length > 0) { %>
                            <% orders.forEach(order => { %>
                                <p>Date: <%= new Date(order.currentDate).toLocaleString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) %></p>
                                <p>Order Id: <%= order.orderId %></p>
                                <p>Payment Method: <%= order.PaymentMethod %></p>
                                <% if (order.UserId) { %>
                                    <p>Mobile: <%= order.UserId.mobile %></p>
                                    <p>Email: <%= order.UserId.email %></p>
                                <% } %>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">My Orders</div>
                    <% if (orders && orders.length > 0) { %>
                        <% orders.forEach(order => { %>
                            <div class="table-responsive">
                                <table class="table table-cart table-mobile">
                                    <tbody>
                                        <% order.items.forEach(item => { %>
                                            <tr>
                                                <td>
                                                    <% if (item.productId && item.productId.Inputimage && item.productId.Inputimage.length > 0) { %>
                                                        <img src="/IMAGES/<%= item.productId.Inputimage[0].filename %>" alt="product image" style="max-width: 60px; max-height: 60px;" class="img-fluid">
                                                    <% } else { %>
                                                        <img src="/IMAGES/default.jpg" alt="default image" style="max-width: 60px; max-height: 60px;" class="img-fluid">
                                                    <% } %>
                                                </td>
                                                <td><%= item.productId ? item.productId.name : 'Unknown Product' %></td>
                                                <td>â‚¹<%= order.totalAmount %></td>
                                                <td>Qty: <%= item.quantity %></td>
                                                <td><%= order.PaymentMethod %></td>
                                            </tr>
                                            <% if (item.status == 'Delivered' && order.approvel == 1) { %>
                                                <tr>
                                                    <td colspan="5" class="text-center">
                                                        <p>Reason: <%= item.reason %></p>
                                                        <button class="btn btn-success" onclick="approvelfun('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')">Approve</button>
                                                        <button class="btn btn-dark" onclick="declinefun('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')">Decline</button>
                                                    </td>
                                                </tr>
                                            <% } %>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <hr>
                        <% }); %>
                    <% } else { %>
                        <p>Your order history is empty.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function approvelfun(orderId, productId) {
        Swal.fire({
            title: 'Are You Sure?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/admin/returnApproved', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId, productId })
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            'Approved',
                            'Return request successfully approved',
                            'success'
                        ).then(() => {
                            window.location.reload();
                        });
                    }
                });
            }
        });
    }

    function declinefun(orderId, productId) {
        Swal.fire({
            title: 'Are You Sure?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/admin/returnDeclined', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId, productId })
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            'Declined',
                            'Return request has been declined',
                            'success'
                        ).then(() => {
                            window.location.reload();
                        });
                    }
                });
            }
        });
    }
</script>

<%- include('../layouts/adminFooter') %>